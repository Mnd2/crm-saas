import { Router } from "express";
import { prisma } from "../config/prisma";
import { authMiddleware } from "../middleware/auth";
import { logAudit } from "../config/audit";

const router = Router();

router.use(authMiddleware);

/**
 * GET /api/v1/contacts
 * Query: search?
 */
router.get("/", async (req, res) => {
  const { organizationId } = req.user!;
  const search = (req.query.search as string | undefined) || "";

  const contacts = await prisma.contact.findMany({
    where: {
      organizationId,
      OR: search
        ? [
            { firstName: { contains: search, mode: "insensitive" } },
            { lastName: { contains: search, mode: "insensitive" } },
            { email: { contains: search, mode: "insensitive" } },
          ]
        : undefined,
    },
    orderBy: { createdAt: "desc" },
  });

  res.json(contacts);
});

/**
 * GET /api/v1/contacts/:id
 */
router.get("/:id", async (req, res) => {
  const { organizationId } = req.user!;
  const { id } = req.params;

  const contact = await prisma.contact.findFirst({
    where: { id, organizationId },
    include: {
      deals: true,
      activities: {
        orderBy: { createdAt: "desc" },
      },
    },
  });

  if (!contact) {
    return res.status(404).json({ message: "Kontaktas nerastas" });
  }

  res.json(contact);
});

/**
 * POST /api/v1/contacts
 */
router.post("/", async (req, res) => {
  const { organizationId, userId } = req.user!;
  const { firstName, lastName, email, phone, company, lifecycleStage, tags } =
    req.body;

  if (!firstName || !lastName) {
    return res.status(400).json({ message: "Vardas ir pavardÄ— privalomi" });
  }

  const contact = await prisma.contact.create({
    data: {
      firstName,
      lastName,
      email,
      phone,
      company,
      lifecycleStage,
      tags: tags ?? [],
      organizationId,
      ownerId: userId,
    },
  });

  await logAudit({
    organizationId,
    userId,
    action: "contact.create",
    entityType: "Contact",
    entityId: contact.id,
    meta: { firstName, lastName },
  });

  res.status(201).json(contact);
});

/**
 * PUT /api/v1/contacts/:id
 */
router.put("/:id", async (req, res) => {
  const { organizationId, userId } = req.user!;
  const { id } = req.params;

  const existing = await prisma.contact.findFirst({
    where: { id, organizationId },
  });

  if (!existing) {
    return res.status(404).json({ message: "Kontaktas nerastas" });
  }

  const { firstName, lastName, email, phone, company, lifecycleStage, tags } =
    req.body;

  const contact = await prisma.contact.update({
    where: { id },
    data: {
      firstName,
      lastName,
      email,
      phone,
      company,
      lifecycleStage,
      tags: tags ?? existing.tags,
    },
  });

  await logAudit({
    organizationId,
    userId,
    action: "contact.update",
    entityType: "Contact",
    entityId: contact.id,
  });

  res.json(contact);
});

/**
 * DELETE /api/v1/contacts/:id
 */
router.delete("/:id", async (req, res) => {
  const { organizationId, userId } = req.user!;
  const { id } = req.params;

  const existing = await prisma.contact.findFirst({
    where: { id, organizationId },
  });

  if (!existing) {
    return res.status(404).json({ message: "Kontaktas nerastas" });
  }

  await prisma.contact.delete({ where: { id } });

  await logAudit({
    organizationId,
    userId,
    action: "contact.delete",
    entityType: "Contact",
    entityId: id,
  });

  res.status(204).send();
});

export default router;
