generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  manager
  user
}

enum ActivityType {
  call
  email
  meeting
  note
  task
}

model Organization {
  id                String   @id @default(uuid())
  name              String
  plan              String   @default("free")
  domain            String?
  timezone          String   @default("Europe/Vilnius")

  prestashopBaseUrl String?
  prestashopApiKey  String?

  emailFrom         String?
  emailSmtpHost     String?
  emailSmtpPort     Int?
  emailSmtpUser     String?
  emailSmtpPassword String?

  prestashopLastSyncAt     DateTime?
  prestashopLastSyncStatus String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  users      User[]
  contacts   Contact[]
  deals      Deal[]
  activities Activity[]
  auditLogs  AuditLog[]
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String
  role           UserRole @default(user)
  isActive       Boolean  @default(true)

  // tiek backend'as, tiek frontend'as naudoja firstName/lastName
  firstName      String?
  lastName       String?

  // backend'o auth maršrutas naudoja `name`, dėl to irgi paliekam
  name           String   @default("")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  activities Activity[] @relation("UserActivities")
  contacts   Contact[]  @relation("UserContacts")
  deals      Deal[]     @relation("UserDeals")
  auditLogs  AuditLog[] @relation("UserAuditLogs")
}

model Contact {
  id               String    @id @default(uuid())
  email            String?
  firstName        String?
  lastName         String?
  phone            String?
  company          String?

  lifecycleStage   String?   // "lead", "customer", "churn-risk" ir pan.
  tags             String[]  // backend'e naudojamas `tags` masyvas

  lastContactedAt  DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  owner   User?   @relation("UserContacts", fields: [ownerId], references: [id])
  ownerId String?

  deals      Deal[]
  activities Activity[]
}

model Deal {
  id             String    @id @default(uuid())
  title          String
  amount         Float?
  currency       String    @default("EUR")
  stage          String    // "prospecting", "qualified", "proposal", ...

  // backend'o /deals kurimas naudoja lauką `source`
  source         String?

  expectedClose  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  owner   User?   @relation("UserDeals", fields: [ownerId], references: [id])
  ownerId String?

  contact   Contact? @relation(fields: [contactId], references: [id])
  contactId String?

  activities Activity[]
}

model Activity {
  id             String       @id @default(uuid())
  type           ActivityType
  subject        String?
  description    String?

  // LABAI SVARBU: dėl šito lauko tau ir rėkia tsc:
  //   'scheduledAt' does not exist in type 'ActivityWhereInput'
  scheduledAt    DateTime?

  completed      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  user   User?    @relation("UserActivities", fields: [userId], references: [id])
  userId String?

  contact   Contact? @relation(fields: [contactId], references: [id])
  contactId String?

  deal   Deal?   @relation(fields: [dealId], references: [id])
  dealId String?
}

model AuditLog {
  id             String   @id @default(uuid())
  action         String
  entityType     String?
  entityId       String?
  ipAddress      String?
  userAgent      String?
  meta           Json?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  user   User?   @relation("UserAuditLogs", fields: [userId], references: [id])
  userId String?
}
